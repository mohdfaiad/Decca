/* Extract Database deccant:d:\gdb\common.gdb */
CREATE DATABASE "deccant:d:\gdb\common.gdb" PAGE_SIZE 1024 
;

/* Domain definitions */
CREATE DOMAIN PHONE_DM AS CHAR(12);
CREATE DOMAIN COMPANY_DM AS CHAR(8);
CREATE DOMAIN PROGRAM_DM AS CHAR(8);
CREATE DOMAIN USER_DM AS CHAR(8);
CREATE DOMAIN MODULE_DM AS CHAR(2);
CREATE DOMAIN FAX_DM AS CHAR(15);
CREATE DOMAIN CURRENCY_DM AS CHAR(4) CHARACTER SET BIG_5;

/* Table: COMPANY, Owner: SYSDBA */
CREATE TABLE COMPANY (COMPANY_ID COMPANY_DM NOT NULL,
        C_NAME CHAR(15) CHARACTER SET BIG_5,
        E_NAME CHAR(40),
        ADDRESS VARCHAR(30) CHARACTER SET BIG_5,
        ACTIVE_SECURITY CHAR(1),
        COMPANY_ANIMATION VARCHAR(60),
        FAX FAX_DM,
        PHONE PHONE_DM,
        CURRENCY CURRENCY_DM,
        AC_LENGTH INTEGER DEFAULT 8
,
        USE_PFT_CTR_1 CHAR(1) DEFAULT "N"
,
        PFT_CTR_1_LEN INTEGER DEFAULT 0
,
        USE_PFT_CTR_2 CHAR(1) DEFAULT "N"
,
        PFT_CTR_2_LEN INTEGER DEFAULT 0
,
        SITE_NO CHAR(1),
PRIMARY KEY (COMPANY_ID));

/* Table: CURRENCY, Owner: SYSDBA */
CREATE TABLE CURRENCY (COMPANY_ID COMPANY_DM NOT NULL,
        CURRENCY CHAR(2) CHARACTER SET BIG_5 NOT NULL,
        BASE_CURRENCY NUMERIC(9, 4),
        FOREIGN_CURRENCY NUMERIC(9, 4),
PRIMARY KEY (COMPANY_ID, CURRENCY));

/* Table: MODULE, Owner: SYSDBA */
CREATE TABLE MODULE (COMPANY_ID COMPANY_DM NOT NULL,
        MODULE_ID MODULE_DM NOT NULL,
        DATABASE_ALIAS CHAR(8),
        SERVER CHAR(60),
        PROG_PATH CHAR(60),
PRIMARY KEY (COMPANY_ID, MODULE_ID));

/* Table: PROFIT_CTR, Owner: SYSDBA */
CREATE TABLE PROFIT_CTR (COMPANY_ID CHAR(8) CHARACTER SET BIG_5 NOT NULL,
        PROFIT_CTR_SEG INTEGER NOT NULL,
        PROFIT_CTR CHAR(2) CHARACTER SET BIG_5 NOT NULL,
        DESCRIPTION CHAR(10) CHARACTER SET BIG_5,
PRIMARY KEY (COMPANY_ID, PROFIT_CTR_SEG, PROFIT_CTR));

/* Table: PROG_DEF, Owner: SYSDBA */
CREATE TABLE PROG_DEF (MODULE_ID MODULE_DM NOT NULL,
        PROG_PATH CHAR(60),
PRIMARY KEY (MODULE_ID));

/* Table: PROG_DESC, Owner: SYSDBA */
CREATE TABLE PROG_DESC (MODULE_ID MODULE_DM NOT NULL,
        PROGRAM_ID CHAR(8) NOT NULL,
        DESCRIPTION CHAR(30) CHARACTER SET BIG_5,
PRIMARY KEY (MODULE_ID, PROGRAM_ID));

/* Table: PROG_PWD, Owner: SYSDBA */
CREATE TABLE PROG_PWD (PROGRAM_ID CHAR(8) NOT NULL,
        FUNCTION_NO INTEGER NOT NULL,
        DESCRIPTION CHAR(30) CHARACTER SET BIG_5,
        MODULE_ID MODULE_DM NOT NULL,
        FUNC_GRP INTEGER default 0
,
PRIMARY KEY (PROGRAM_ID, FUNCTION_NO));

/* Table: TCOMPANY, Owner: SYSDBA */
CREATE TABLE TCOMPANY (COMPANY_ID COMPANY_DM NOT NULL,
        C_NAME CHAR(15) CHARACTER SET BIG_5,
        E_NAME CHAR(20) CHARACTER SET BIG_5,
        ADDRESS VARCHAR(30) CHARACTER SET BIG_5,
        ACTIVE_SECURITY CHAR(1),
        COMPANY_ANIMATION VARCHAR(30) CHARACTER SET BIG_5,
        FAX FAX_DM,
        PHONE PHONE_DM,
        CURRENCY CHAR(2) CHARACTER SET BIG_5,
        AC_LENGTH INTEGER DEFAULT 8
,
        USE_PFT_CTR_1 CHAR(1) DEFAULT "N"
,
        PFT_CTR_1_LEN INTEGER DEFAULT 0
,
        USE_PFT_CTR_2 CHAR(1) DEFAULT "N"
,
        PFT_CTR_2_LEN INTEGER DEFAULT 0
);

/* Table: USER_FILE, Owner: SYSDBA */
CREATE TABLE USER_FILE (USER_ID USER_DM NOT NULL,
        USER_NAME CHAR(10) CHARACTER SET BIG_5 NOT NULL,
        PASSWD CHAR(10),
        DEPT CHAR(4),
        LST_COMPANY COMPANY_DM,
        FIX_COMPANY CHAR(1) default "N"
,
PRIMARY KEY (USER_ID));

/* Table: USER_PRG, Owner: SYSDBA */
CREATE TABLE USER_PRG (COMPANY_ID COMPANY_DM NOT NULL,
        PROGRAM_ID PROGRAM_DM NOT NULL,
        USER_ID USER_DM NOT NULL,
        FUNC_APPROVED CHAR(99),
PRIMARY KEY (COMPANY_ID, PROGRAM_ID, USER_ID));

/*  Index definitions for all user tables */
CREATE INDEX PROG_PWD_IDX2 ON PROG_PWD(PROGRAM_ID, FUNC_GRP, FUNCTION_NO);


SET TERM ^ ;

/* Triggers only will work for SQL triggers */
CREATE TRIGGER PROG_PWD_UPDATE FOR PROG_PWD                        
ACTIVE BEFORE UPDATE POSITION 0 
as 
begin
  if (old.PROGRAM_ID <> new.PROGRAM_ID) then
    update USER_PRG
       set PROGRAM_ID = new.PROGRAM_ID
     where PROGRAM_ID = old.PROGRAM_ID;
end
 ^
CREATE TRIGGER PROG_PWD_DELETE FOR PROG_PWD                        
ACTIVE BEFORE DELETE POSITION 0 
as 
begin
  delete from USER_PRG
     where PROGRAM_ID = old.PROGRAM_ID;
end
 ^
CREATE TRIGGER TCOMPANY_DELETE FOR TCOMPANY                        
ACTIVE BEFORE DELETE POSITION 0 
as 
begin
  delete from MODULE
   where COMPANY_ID = old.COMPANY_ID;
  delete from USER_PRG
   where COMPANY_ID = old.COMPANY_ID;
end
 ^
CREATE TRIGGER TCOMPANY_UPDATE FOR TCOMPANY                        
ACTIVE BEFORE UPDATE POSITION 0 
as 
begin
  if (old.COMPANY_ID <> new.COMPANY_ID) then
  begin
    update MODULE
      set COMPANY_ID = new.COMPANY_ID
     where COMPANY_ID = old.COMPANY_ID;
    update USER_PRG
       set COMPANY_ID = new.COMPANY_ID
     where COMPANY_ID = old.COMPANY_ID;
  end
end
 ^
COMMIT WORK ^
SET TERM ; ^

/* Grant permissions for this database */
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON COMPANY TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON CURRENCY TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON MODULE TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PROFIT_CTR TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PROG_DEF TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PROG_DESC TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PROG_PWD TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON USER_FILE TO PUBLIC;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON USER_PRG TO PUBLIC;

